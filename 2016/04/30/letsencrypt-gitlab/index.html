<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hands on Let's Encrypt &mdash; GerardSoleCa</title>
    <link href="https://fonts.googleapis.com/css?family=Droid+Sans:400,700" rel="stylesheet" type="text/css">
    <link type="text/css" rel="stylesheet" href="/assets/bootstrap/bootstrap.css">
    <link type="text/css" rel="stylesheet" href="/assets/main.css">
    <link type="text/css" rel="stylesheet" href="/assets/fontawesome/font-awesome.css">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/images/"/>
    <link href="/feed.xml" rel="alternate" type="application/rss+xml" title="GerardSoleCa" />
    <meta name="title" content="Hands on Let's Encrypt ">
    <link rel="canonical" href="http://gerardsoleca.github.io/2016/04/30/letsencrypt-gitlab/">
    
    
    <meta property="og:title" content="Hands on Let's Encrypt "/>
    <meta property="og:url" content="http://gerardsoleca.github.io/2016/04/30/letsencrypt-gitlab/"/>
    
    
    <meta property="og:description" content="Let’s Encrypt is a new Certificate Authority: It’s free, automated, and open. And finally I've been able to use it for an internal GitLab server that we used over http. Now we are running over https!"/>
    <meta name="description" content="Let’s Encrypt is a new Certificate Authority: It’s free, automated, and open. And finally I've been able to use it for an internal GitLab server that we used over http. Now we are running over https!"/>
    

    <meta property="og:site_name" content="GerardSoleCa">
</head>
<body>

<section class="site-nav">
    <header>
        <nav id="navigation">
            <a class="brand" href="/">
                
            </a>
            <a href="/" class="home">Blog</a>
            
            <a href="/about">About</a>
        </nav>
        
    </header>
</section>

<div class="blog-cover" style="background-image:url(/images/bridge.jpg);">

    <section>
        <div class="container">
            <h1>GerardSoleCa</h1>
            <h3>Pushing my dev adventures to the world</h3>

            
             <a href="http://es.linkedin.com/in/gerardsoleca" title="See LinkedIn" target="_blank"><i class="fa fa-linkedin"></i></a>
            
            
             <a href="https://github.com/GerardSoleCa" title="Open GerardSoleCa's Github" target="_blank"><i class="fa fa-github"></i></a>
            
            
            <a href="https://twitter.com/GerardSoleCa" title="Follow on Twitter" target="_blank"><i class="fa fa-twitter"></i></a>
            
            
            <a href="/feed.xml" title="RSS Feed">
                <i class="fa fa-rss"></i>
            </a>
        </div>
    </section>
</div>


<article>

    <div class="container ">
        <header>
            <div class="meta">
                By <address><a rel="author" href="http://gsole.cat" title="Gerard Solé" target="_blank">Gerard Solé</a></address> &mdash;
                <time pubdate datetime="2016-30-April" title="April 30, 2016">April 30, 2016</time>
            </div>
            <h1 class="title">Hands on Let's Encrypt</h1>
            <h2 class="subtitle">Let’s Encrypt is a new Certificate Authority: It’s free, automated, and open.</h2>
        </header>

        <section>
            <p>Let’s Encrypt is a new Certificate Authority: It’s free, automated, and open. And finally I’ve been able to use it for an internal GitLab server that we used over http. Now we are running over https!</p>

<p><img src="https://letsencrypt.org/images/letsencrypt-logo-horizontal.svg" alt="Let's Encrypt" /></p>

<p>This entry is a <em>tl;dr</em> of <a href="https://webnugget.de/setting-up-gitlab-with-free-ssl-certs-from-lets-encrypt-on-ubuntu-14-04/">https://webnugget.de/setting-up-gitlab-with-free-ssl-certs-from-lets-encrypt-on-ubuntu-14-04/</a> which explains from the very beginning how to implement the full software stack. Here I’m omitting some parts and some descriptions. I’m also using this post entry as a preservation of the original content. So full merits for them.
<!-- more --></p>

<h2 id="install-lets-encrypt">Install Let’s Encrypt</h2>
<p>As we want to use Let’s Encrypt to generate valid server certificates first of all the required software will be installed. Remember to elevate your permissions to admin rights.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">sudo su</code></pre></figure>

<p>Then, install git and clone the project repository.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">apt-get update
apt-get install git
<span class="nb">cd</span> /root
git clone https://github.com/letsencrypt/letsencrypt  </code></pre></figure>

<h2 id="configure-lets-encrypt">Configure Let’s Encrypt</h2>
<p>This will provide the necessary configuration to resolve Let’s Encrypt certificates.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">mkdir /root/letsencrypt-config
nano /root/letsencrypt-config/gitlab.ini</code></pre></figure>

<p>Paste the following lines. Remember to change the <em>domains</em> and <em>email</em> lines. Email will be used by let’s encrypt just in case something happen with your certificate.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c"># this is the let's Encrypt config for our gitlab instance</span>

<span class="c"># use the webroot authenticator.</span>
 authenticator <span class="o">=</span> webroot
<span class="c"># the following path needs to be served by our webserver</span>
<span class="c"># to validate our domains</span>
 webroot-path <span class="o">=</span> /var/www/letsencrypt

<span class="c"># generate certificates for the specified domains.</span>
domains <span class="o">=</span> gitlab.yourdomain.com

<span class="c"># register certs with the following email address</span>
email <span class="o">=</span> your@email.com

<span class="c"># use a 4096 bit RSA key instead of 2048</span>
rsa-key-size <span class="o">=</span> 4096  </code></pre></figure>

<p>Then, create the directory which will serve the authentication files.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">mkdir -p /var/www/letsencrypt</code></pre></figure>

<h2 id="configure-gitlab">Configure GitLab</h2>

<p>Edit GitLab’s configuration:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">nano /etc/gitlab/gitlab.rb</code></pre></figure>

<p>Remember to change <em>gitlab.yourdomain.com</em> to your server Hostname. Keep in mind that some of the following configurations could already be on your GitLab instance. <strong>Proceed with caution</strong>.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">external_url <span class="s2">"http://gitlab.yourdomain.com/"</span>

nginx[<span class="s1">'redirect_http_to_https'</span><span class="o">]</span> <span class="o">=</span> <span class="nb">true

</span>nginx[<span class="s1">'ssl_certificate'</span><span class="o">]=</span> <span class="s2">"/etc/letsencrypt/live/gitlab.yourdomain.com/fullchain.pem"</span>

nginx[<span class="s1">'ssl_certificate_key'</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"/etc/letsencrypt/live/gitlab.yourdomain.com/privkey.pem"</span>

nginx[<span class="s1">'custom_gitlab_server_config'</span><span class="o">]=</span><span class="s2">"location ^~ /.well-known {</span><span class="se">\n</span><span class="s2"> alias /var/www/letsencrypt/.well-known;</span><span class="se">\n</span><span class="s2">}</span><span class="se">\n</span><span class="s2">"</span>  </code></pre></figure>

<p>Apply the new configuration.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">gitlab-ctl reconfigure</code></pre></figure>

<h2 id="getting-the-certificates">Getting the certificates</h2>

<p>To get the certificates, run the following command:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">/root/letsencrypt/letsencrypt-auto certonly -c /root/letsencrypt-config/gitlab.ini</code></pre></figure>

<p>Once the certificates are resolved, change again GitLab’s configuration.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">nano /etc/gitlab/gitlab.rb</code></pre></figure>

<p><em>change the external_url to use https instead of http</em></p>

<p>After that, apply again the configuration.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">gitlab-ctl reconfigure</code></pre></figure>

<p>Now, you should be able to access to your GitLab instance by https instead of http.</p>

<h1 id="autoupdate-for-certificates">Autoupdate for certificates</h1>

<p>Let’s Encrypt certificates have a valid life of 90 days, so to it’s important to keep them up to date. A cron job will be used to renew the certificate once per month.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">nano /etc/cron.monthly/renew-ssl-certificates</code></pre></figure>

<p>Paste the following configuration:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#!/bin/bash</span>

/root/.local/share/letsencrypt/bin/letsencrypt certonly -c /root/letsencrypt-config/gitlab.ini --renew-by-default

gitlab-ctl restart</code></pre></figure>

<p>Finally give execution permisions to the file.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">chmod +x /etc/cron.monthly/renew-ssl-certificates</code></pre></figure>


            
<div class="social">
    <div>
        <a href="https://twitter.com/share" class="twitter-share-button"  data-text="Hands on Let's Encrypt" data-related="GerardSoleCa">Tweet</a>
    </div>
    
    
    
    
    
</div>

        </section>

        <footer>
            <address>
               <img src="/images/gs.jpg">
                <p>Written by <strong><a rel="author" href="https://twitter.com/GerardSoleCa" title="" target="_blank">Gerard Solé</a></strong><br>
                <span class="muted">Software Engineer</span>
                </p>
            </address>

        </footer>

        
    </div>
</article>


<footer class="site-footer">
    <div class="container">
        &copy; 2016

        <nav>
            <a href=""></a> &middot;
            <a href="/">Blog</a> &middot;
            
            <a href="/about">About</a>
        </nav>
        <p>Incorporated theme by <a href="https://sendtoinc.com">Inc</a> and modified by <a href="https://gerardsoleca.github.io">GerardSoleCa</a></p>
    </div>
</footer>

<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script type="text/javascript" src="/assets/main.js"></script>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>




  <!--google analytics tracking code here-->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-66293604-1', 'auto');
  ga('send', 'pageview');

</script>




</body>
</html>
